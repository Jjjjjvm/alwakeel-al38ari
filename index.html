<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد الذكاء الاصطناعي العام</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Almarai for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Apply Almarai font and light background to the body */
        body {
            font-family: 'Almarai', sans-serif;
            background-color: #f0fdf4; /* Very light green background */
        }
        /* Custom styling for chat messages for better visual distinction */
        .chat-message.user {
            background-color: #dcfce7; /* Light green for user messages */
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem; /* Rounded corners for user bubble */
            margin-right: auto; /* Push user message to the right */
        }
        .chat-message.ai {
            background-color: #e0f2fe; /* Light blue for AI messages */
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem; /* Rounded corners for AI bubble */
            margin-left: auto; /* Push AI message to the left */
        }
        /* Styling for the loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey outer ring */
            border-top: 4px solid #10b981; /* Emerald colored spinning part */
            border-radius: 50%; /* Make it circular */
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite; /* Spin animation */
            margin: 0.5rem auto; /* Center the loader */
        }
        /* Keyframe animation for the spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800 flex flex-col min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-2xl flex-grow flex flex-col">

        <!-- Header Section -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-green-800">مساعد الذكاء الاصطناعي العام</h1>
            <p class="text-md text-gray-600 mt-1">يمكنني مساعدتك في مجموعة واسعة من المواضيع</p>
        </header>

        <!-- Chat Messages Display Area -->
        <div id="chat-messages" class="flex-grow bg-white p-4 rounded-2xl shadow-lg overflow-y-auto mb-4 flex flex-col space-y-4">
            <!-- Initial welcome message (dynamically added by JS for consistency with chatHistory) -->
        </div>

        <!-- Chat Input and Send Button -->
        <div class="flex flex-col sm:flex-row gap-3 bg-white p-4 rounded-2xl shadow-lg">
            <textarea id="user-input" rows="2" class="flex-grow p-3 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all resize-none" placeholder="اكتب سؤالك أو طلبك هنا..."></textarea>
            <button id="send-button" class="flex-shrink-0 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 flex items-center justify-center">
                <span id="button-text">إرسال</span>
                <!-- SVG Spinner Icon (hidden by default) -->
                <svg id="button-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
        
        <!-- Loader for AI response, positioned below input but usually hidden -->
        <div id="loader" class="loader hidden"></div>

    </div>

    <!-- Footer Section -->
    <footer class="text-center mt-6 text-gray-500 text-sm py-4">
        <p>تم التطوير بواسطة Gemini. لمساعدتك في أي استفسار.</p>
    </footer>

    <script>
        // Get references to DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const loader = document.getElementById('loader');

        // chatHistory will store the conversation, starting with a system instruction and AI welcome
        let chatHistory = [];

        // Add a system-like instruction for the AI's persona and behavior
        // This is part of the initial 'user' message to guide the model's responses throughout the session
        chatHistory.push({
            role: "user",
            parts: [{ text: `
                أنت مساعد ذكاء اصطناعي عام ومفيد للغاية. مهمتك هي الإجابة على استفسارات المستخدمين حول مجموعة واسعة من المواضيع، بما في ذلك:
                - تقديم معلومات وحقائق.
                - شرح المفاهيم المعقدة بطريقة مبسطة.
                - المساعدة في الكتابة الإبداعية أو صياغة النصوص.
                - تقديم نصائح عامة حول مواضيع مختلفة (بما لا يتعارض مع التخصصات التي تتطلب خبراء بشريين مثل الطب، القانون، الاستثمار المالي المباشر).
                - حل المشكلات المنطقية أو الرياضية.
                - تلخيص النصوص الطويلة.

                **قواعد عامة للتعامل مع الطلبات:**
                - **الرد بأقصر رد ممكن:** قدم الإجابة الأكثر إيجازاً ومباشرة دون إطالة، مع الحفاظ على الفائدة والدقة.
                - حاول دائماً الإجابة على استفسار المستخدم قدر الإمكان بناءً على معرفتك الواسعة.
                - اجعل إجاباتك دقيقة ومفيدة.
                - استخدم اللغة العربية الفصحى بشكل أساسي، مع القدرة على الرد باللغة الإنجليزية إذا كان السؤال بالإنجليزية أو طلب المستخدم ذلك صراحة.
                - إذا كان السؤال يتطلب بيانات في الوقت الفعلي (مثل أسعار الأسهم الحية، حالة الطقس الآن، أحدث الأخبار، أو البحث عن منتجات معينة معروضة للبيع بأسعار فورية)، أو يتطلب استشارة متخصصة (طبية، قانونية، مالية استثمارية مباشرة)، يجب أن توضح للمستخدم أنك لا تستطيع تقديم هذه المعلومات مباشرة.
                - في مثل هذه الحالات (التي تتطلب بيانات حية أو استشارات متخصصة)، قم بتوجيه المستخدم للبحث بنفسه على محركات البحث العامة أو المواقع المتخصصة والموثوقة (مثل المواقع الإخبارية، مواقع البحث عن عقارات/منتجات، أو استشارة خبراء بشريين في المجال المعني).
                - إذا كان الطلب غامضاً جداً أو خارج نطاق قدراتك كنموذج لغوي، اطلب من المستخدم إعادة صياغة سؤاله.

                **أمثلة على كيفية التوجيه (في حال عدم القدرة على تقديم معلومات مباشرة):**
                "أعتذر، لا أستطيع البحث في الوقت الفعلي عن [نوع المعلومة المطلوبة]. دوري هو تقديم معلومات عامة. أنصحك بزيارة [مثال: محرك بحث جوجل]."
                "أنا نموذج ذكاء اصطناعي، ولا يمكنني تقديم استشارات طبية. أنصحك باستشارة خبير بشري."

                اجعل تفاعلك ودودًا ومحايدًا.
                `
            }]
        });

        // Add the initial 'model' (AI) welcome message after the persona setup
        chatHistory.push({
            role: "model",
            parts: [{ text: "مرحباً بك! أنا مساعدك العام بالذكاء الاصطناعي. كيف يمكنني مساعدتك اليوم؟" }]
        });

        // Append the initial AI welcome message to the display when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            appendMessage(chatHistory[1].parts[0].text, 'ai');
        });

        // --- Event Listener for the Send Button ---
        sendButton.addEventListener('click', sendMessage);
        
        // Allow pressing Enter key to send the message (Shift+Enter for new line)
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevents adding a new line
                sendMessage(); // Call the send message function
            }
        });

        /**
         * Appends a message to the chat display.
         * @param {string} message - The text content of the message.
         * @param {string} sender - 'user' or 'ai' to determine styling.
         */
        function appendMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender, 'p-3', 'max-w-xs', 'sm:max-w-md', 'text-sm', 'shadow-md');
            
            if (sender === 'ai') {
                let formattedMessage = message;
                // Replace any raw URLs with clickable links
                formattedMessage = formattedMessage.replace(
                    /(https?:\/\/[^\s]+)/g, 
                    (match) => {
                        return `<a href="${match}" target="_blank" class="text-blue-600 hover:underline">${match}</a>`;
                    }
                );
                messageDiv.innerHTML = formattedMessage;
            } else {
                messageDiv.textContent = message;
            }
            chatMessages.appendChild(messageDiv);
            // Scroll to the bottom of the chat to show the latest message
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Handles sending a message: gets user input, displays it, calls AI, and displays AI response.
         */
        async function sendMessage() {
            const userMessage = userInput.value.trim();

            if (!userMessage) {
                return; // Do nothing if the input is empty
            }

            // Clear the input field
            userInput.value = '';

            // Append user message to display and history
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            appendMessage(userMessage, 'user'); // Append after adding to history to avoid race condition

            // Set UI to loading state
            setLoadingState(true);

            try {
                // Call the Gemini API with the full chat history for context
                const aiResponse = await callGeminiAPI(chatHistory);

                // Append AI response to display and history
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                appendMessage(aiResponse, 'ai'); // Append after adding to history

            } catch (error) {
                console.error("Error communicating with AI:", error);
                appendMessage("عذراً، حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى المحاولة مرة أخرى.", 'ai');
            } finally {
                // Restore UI from loading state
                setLoadingState(false);
            }
        }

        /**
         * Toggles the UI between loading and idle states.
         * @param {boolean} isLoading - True to show loading indicators, false to hide them.
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                sendButton.disabled = true; // Disable send button
                buttonText.classList.add('hidden'); // Hide button text
                buttonSpinner.classList.remove('hidden'); // Show button spinner
                loader.classList.remove('hidden'); // Show main loader
                userInput.disabled = true; // Disable input field
            } else {
                sendButton.disabled = false; // Enable send button
                buttonText.classList.remove('hidden'); // Show button text
                buttonSpinner.classList.add('hidden'); // Hide button spinner
                loader.classList.add('hidden'); // Hide main loader
                userInput.disabled = false; // Enable input field
                userInput.focus(); // Focus on input for next message
            }
        }

        /**
         * Calls the Gemini API with the chat history.
         * @param {Array<Object>} history - The array of message objects (role and parts).
         * @returns {Promise<string>} - The generated text from the model.
         * @throws {Error} If the API request fails or the response structure is unexpected.
         */
        async function callGeminiAPI(history) {
            const payload = { contents: history }; // Payload includes the full chat history
            // The API key is an empty string and will be handled by the environment.
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`فشل طلب واجهة برمجة التطبيقات بحالة ${response.status}. انظر وحدة التحكم للمزيد من التفاصيل.`);
            }
            
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    throw new Error(`تم حظر الطلب. السبب: ${result.promptFeedback.blockReason}`);
                }
                throw new Error("لم يتمكن الذكاء الاصطناعي من تكوين إجابة. قد يكون السؤال غير واضح.");
            }
        }
    </script>

</body>
</html>
